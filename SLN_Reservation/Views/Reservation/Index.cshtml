@model  SLN_Reservation.DTO.ReservationDto

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";

}
<style>
    .room-card {
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 1rem;
        width: 220px;
        cursor: pointer;
        background-color: white;
        box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

        .room-card:hover {
            transform: scale(1.02);
            border-color: #2c3e50;
        }

        .room-card.selected {
            border: 2px solid #2c3e50;
            background-color: #eaf2f8;
        }
    #roomCardsScroll {
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 0.5rem;
        border-radius: 10px;
    }
        #roomCardsScroll::-webkit-scrollbar {
            width: 10px;
        }

        #roomCardsScroll::-webkit-scrollbar-thumb {
            background-color: #aaa;
            border-radius: 4px;
        }


    .modal-xl .modal-body {
        max-height: 70vh;
        overflow-y: auto;
        overflow-x: hidden;
    }

    #expenseBreakdown table td,
    #expenseBreakdown table th {
        vertical-align: middle;
        padding: 0.5rem;
    }
    .external-true {
        background-color: #d4edda;
    }

    .external-false {
        background-color: #f8d7da;
    }

</style>

<h2 style="text-align-last: center;">Reservación de hospedaje</h2>


<div class="mt-4 p-3 bg-light" style="border-top: 1px solid #ddd; text-align: center;">
    <div class="row">
        <div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                <h5 class="text-dark">Venta</h5>
                <p class="mb-0">Precio: <span class="text-dark">₡ @ViewBag.SaleValue</span></p>
                <p class="mb-0">Fecha: <span class="text-dark">@ViewBag.SaleDate</span></p>
            </div>
        </div>  <div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                <h5 class="text-dark">Precio del dolar</h5>

            </div>
        </div>
        <div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                <h5 class="text-dark">Compra</h5>
                <p class="mb-0">Precio: <span class="text-dark">₡ @ViewBag.BuyValue</span></p>
                <p class="mb-0">Fecha: <span class="text-dark">@ViewBag.BuyDate</span></p>
            </div>
        </div>
    </div>
</div>


<div class="col-md-4 pb-1">
    <label style="padding-bottom:1rem;"> Estado</label>
    <select id="ddlReservationStatus" class="form-control">
        <option value="0">Todos</option>
        <option value="4" selected>Reservado y facturado</option>
        <option value="1">Reservado</option>
        <option value="2">Facturado</option>
        <option value="3">Finalizado</option>
    </select>
</div>
<div class="row" style="padding-bottom: 1rem; padding-top: 2rem; justify-content: right; ">
    <div class="col-md-8">
        <div class="row">
            <div class="col-md-5">
                <div class="form-group">
                    <label for="txtCheckInReservation">Fecha Inicio:</label>
                    <input type="date" class="form-control" id="txtCheckInReservation" name="txtCheckInReservation">
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-group">
                    <label for="txtCheckOutReservation">Fecha Final:</label>
                    <input type="date" class="form-control" id="txtCheckOutReservation" name="txtCheckOutReservation">
                </div>
            </div>
            <div class="col-md-2" style="padding-top: 1%">
                <button type="button" style="width:100%" onclick="FilterReservacion();" class="btn green-button" id="btnBuscar">Buscar</button>
            </div>
        </div>
        <br />
    </div>
    <div class="col-md-4">
        <div class="col-xs" style="text-align: right;">
            @{

                <button type="button" id="btnModalAddRole" onclick="OpenModal('mdlAddReservation');" class="btn green-button">
                    Agregar reservación <i class="fas fa-plus"></i>
                </button>

            }
        </div>
    </div>
</div>

<div id="contenedorVistaParcial" style="padding-bottom: 2rem;">
    @Html.Partial("PartialViewReservation", Model)
    <br />
</div>



@*Modal to add Reservation*@
<div class="modal fade" id="mdlAddReservation">
    <div class="modal-dialog modal-xl dialogPDF">
        <div class="modal-content contentPDF" style=" margin-top: 4rem;">
            <div class="modal-header" style="background-color: #2C3E50; color: white; justify-content: center;">
                <h5 class="modal-title">Agregar Reservaciones</h5>
            </div>
            <div class="modal-body">
                <div class="row" style=" padding-left: 3rem;">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="form-group">
                                <label for="ddlAddReservationModal">Selecciona el cliente</label>
                                <select id="ddlAddReservationModal" class="form-control" style="width: 85%;"></select>

                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="mb-3">
                                <div class="form-group">
                                    <label for="lblCheckIn" class="form-label">Entrada:</label>
                                    <input type="date" class="form-control" id="txtCheckIn" required>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="mb-3">
                                <div class="form-group">
                                    <label for="lblCheckOut" class="form-label">Salida:</label>
                                    <input type="date" class="form-control" id="txtCheckOut" required>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="mb-3">
                                <div class="form-group">
                                    <input type="hidden" id="ddlAddRoomModal" />
                                    <label for="txtGuestCount" class="form-label">Cantidad de huéspedes</label>
                                    <input type="number" class="form-control" id="txtGuestCount" min="1" value="1" required />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="form-group">
                                <label for="txtDescription" class="form-label">Descripción:</label>
                                <textarea class="form-control" id="txtDescription" rows="3"
                                          placeholder="Ingresa una descripción opcional…"></textarea>
                            </div>
                        </div>
                        </div>
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                                <div class="form-group">
                                    <label>Selecciona una habitación</label>
                                    <div id="roomCardsScroll">
                                        <div id="roomCardsContainer" class="d-flex flex-wrap gap-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">

                                <div class="mb-3">
                                    <label class="form-label">Total a pagar:</label>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <tbody>
                                                <tr>
                                                    <th>Noches</th>
                                                    <td class="text-end"><span id="ebNumberNight"></span></td>
                                                </tr>
                                                <tr>
                                                    <th>Precio por noche</th>
                                                    <td class="text-end">₡<span id="ebPricePerNight">0.00</span></td>
                                                </tr>
                                                <tr>
                                                    <th>SubTotal</th>
                                                    <td class="text-end">₡<span id="ebSubTotal">0.00</span></td>
                                                </tr>
                                                <tr>
                                                    <th>Impuesto</th>
                                                    <td class="text-end">₡<span id="ebTax">0.00</span></td>
                                                </tr>
                                                <tr class="table-active">
                                                    <th>Total</th>
                                                    <td class="text-end fw-bold">₡<span id="ebTotal">0.00</span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>


                            </div>
                        </div>

                    </div>

            </div>
            <br />
            <div class="modal-footer">
                <button type="button" id="btnAddReservation" class="btn green-button" onclick="NewReservation()">Aceptar</button>
                <button type="button" id="btnCloseModalAddReservation" class="btn red-button" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


@*Modal to Modify Reservation*@
<div class="modal fade" id="mdlModifyReservation">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style=" margin-top: 4rem;">
            <div class="modal-header" style="background-color: #2E7D32; color:white; justify-content: center; ">
                <h5 class="modal-title">Modificar Reservaciones</h5>
            </div>
            <div class="modal-body">
                <div class="row" style=" padding-left: 3rem;">
                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="form-group">
                                <label for="ddlModifyReservationModal">Selecciona el cliente</label>
                                <input type="text" id="ddlModifyReservationModal" disabled list="ModifyReservationList" class="form-control" placeholder="Buscar cliente...">
                                <datalist id="ModifyReservationList">

                                    @{
                                        if ((IEnumerable<SelectListItem>)ViewBag.ClientList != null)
                                        {
                                            foreach (var item in (IEnumerable<SelectListItem>)ViewBag.ClientList)
                                            {
                                                <option value="@item.Value">@item.Text</option>
                                            }

                                        } }
                                </datalist>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="form-group">
                                <label for="ddlModifyTarifaModal">Selecciona la tarifa</label>
                                <input type="text" id="ddlModifyTarifaModal" list="ModifyTarifaList" class="form-control" placeholder="Buscar tarifa...">
                                <datalist id="ModifyTarifaList">
                                </datalist>
                            </div>

                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="mb-3">
                                <label for="lblModifyCheckIn" class="form-label">Entrada:</label>
                                <input type="date" class="form-control" id="txtModifyCheckIn" required>
                            </div>

                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="mb-3">
                                <label for="lblModifyCheckOut" class="form-label">Salida:</label>
                                <input type="date" class="form-control" id="txtModifyCheckOut" required>
                            </div>

                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">

                            <div class="mb-3">
                                <label for="lblMDescription" class="form-label">Descripción:</label>
                                <textarea class="form-control" id="txtModifyDescription" disabled="disabled" cols="60" rows="8"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="mb-3">
                                <label for="txtModifyDesglose" class="form-label">Desglose:</label>
                                <textarea class="form-control" id="txtModifyDesglose" disabled="disabled" cols="60" rows="8"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                            <div class="mb-3">
                                <input type="hidden" id="hdfIdReservationModify" />
                            </div>

                        </div>
                    </div>
                </div>

            </div>
            <br />
            <div class="modal-footer">
                <input type="text" class="form-control" style="display:none" id="txtTmpIDModal" readonly>
                <button type="button" id="btnModifyReservation" class="btn green-button" onclick="ModifyReservation()">Aceptar</button>
                <button type="button" id="btnCloseModalModifyReservation" class="btn red-button" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@*Modal Deposito*@
<div class="modal fade" id="mdlDeposit">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style=" margin-top: 4rem;">
            <div class="modal-header" style="background-color: #2E7D32; color:white; justify-content: center; ">
                <h5 class="modal-title">Agregar Depósito</h5>
            </div>
            <div class="modal-body">
                <div class="row" style=" padding-left: 3rem;">

                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 pt-4 p-0">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">

                            <div class="mb-3">
                                <label for="txtDepositAmmount" class="form-label">Deposito:</label>
                                <input type="number" class="form-control" id="txtDepositAmmount" cols="60" rows="8"></input>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <br />
            <div class="modal-footer">
                <input type="text" class="form-control" style="display:none" id="txtTmpIDModal" readonly>
                <button type="button" id="btnModifyReservation" class="btn green-button" onclick="SendDeposit()">Aceptar</button>
                <button type="button" class="btn red-button" id="btncloseDeposit" onclick="CloseModalDeposit()">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    var reservationList = @Html.Raw(Json.Encode(Model));
    $(document).ready(function () {

        OpenModalAddReservation();
        CloseModalAddReservation();
        CloseModalModifyReservation();


        var fechaActual = new Date();
        var fechaFormateada = fechaActual.toISOString().split('T')[0];
        $('#txtCheckIn').val(fechaFormateada);
        $('#txtCheckOut').val(fechaFormateada);
        $('#txtCheckInReservation').val(fechaFormateada);
        $('#txtCheckOutReservation').val(fechaFormateada);
        if ($.fn.DataTable.isDataTable('#tblReservation')) {
            $('#tblReservation').DataTable().destroy();
        }

        $('#tblReservation').DataTable({
                
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "responsive": true,
                "buttons": [
                    'copy', 'excel', 'pdf', 'print'
                ],
                "lengthMenu": [[5, 10, 25, 50, 100], [5, 10, 25, 50, "Todo"]],
                "language": {
                    "lengthMenu": "Mostrar _MENU_ registros por página",
                    "zeroRecords": "No se encontraron registros",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    "infoEmpty": "No hay registros disponibles",
                    "infoFiltered": "(filtrados de _MAX_ registros en total)",
                    "search": "Buscar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                }
            });



              $('#ddlReservationStatus').change(function() {
                 var selectedValue = $(this).val();
                  var checkInVal = $('#txtCheckInReservation').val();
                  var checkOutVal = $('#txtCheckOutReservation').val();

                  if (!(checkInVal instanceof Date)) checkInVal = new Date(checkInVal);
                  if (!(checkOutVal instanceof Date)) checkOutVal = new Date(checkOutVal);


                  var formattedStartDate = checkInVal.toISOString().slice(0, 19).replace('T', ' ');
                  var formattedEndDate = checkOutVal.toISOString().slice(0, 19).replace('T', ' ');

                  mostrarSpinner();
             $.ajax({
                url: '@Url.Action("SeachReservationByStatus", "Reservation")',
                type: 'GET',
                 data: {
                     reservationStatus: selectedValue,
                     StartDate: formattedStartDate,
                     EndDate: formattedEndDate
                 },
                 success: function (partialView) {
                     if ($.fn.DataTable.isDataTable('#tblReservation')) {
                         $('#tblReservation').DataTable().destroy();
                     }
                    $('#contenedorVistaParcial').html(partialView);

                    $('#tblReservation').DataTable({
                        "scrollX": true,
                        "paging": true,
                        "lengthChange": true,
                        "searching": true,
                        "ordering": true,
                        "responsive": true,
                        "buttons": [
                            'copy', 'excel', 'pdf', 'print'
                        ],
                        "lengthMenu": [[5, 10, 25, 50, 100], [5, 10, 25, 50, "Todo"]],
                        "language": {
                            "lengthMenu": "Mostrar _MENU_ registros por página",
                            "zeroRecords": "No se encontraron registros",
                            "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                            "infoEmpty": "No hay registros disponibles",
                            "infoFiltered": "(filtrados de _MAX_ registros en total)",
                            "search": "Buscar:",
                            "paginate": {
                                "first": "Primero",
                                "last": "Último",
                                "next": "Siguiente",
                                "previous": "Anterior"
                            }
                        }
                    });
                },
                    error: function() {
                    alert('Ha ocurrido un error al obtener los datos.');
                                }
                    });
                  ocultarSpinner();
              });




        $('#txtCheckIn').on('change', function () {
            var originalCheckIn = $(this).data('lastValue');
            var newCheckIn = $(this).val();
            var checkOutVal = $('#txtCheckOut').val();

            if (new Date(newCheckIn) >= new Date(checkOutVal)) {
                if (originalCheckIn) {
                    $(this).val(originalCheckIn);
                }
            } else {
                $(this).data('lastValue', newCheckIn);
                var Days = tmpDays(newCheckIn, checkOutVal);


                    Expense_Details( Days, 'txtExpenseDetails');
                    var guestCount = parseInt($("#txtGuestCount").val()) || 1;
                    updateDatalistHotelRoomFromServer( 'AddRoomList', newCheckIn, checkOutVal, guestCount);

            }
        }).data('lastValue', $('#txtCheckIn').val());

        $('#txtCheckOut').on('change', function () {
            var originalCheckOut = $(this).data('lastValue');
            var newCheckOut = $(this).val();
            var checkInVal = $('#txtCheckIn').val();

            if (new Date(newCheckOut) <= new Date(checkInVal)) {
                if (originalCheckOut) {
                    $(this).val(originalCheckOut);
                }
            } else {
                $(this).data('lastValue', newCheckOut);
                var Days = tmpDays(checkInVal, newCheckOut);


                    Expense_Details( Days, 'txtExpenseDetails');
                    var guestCount = parseInt($("#txtGuestCount").val()) || 1;
                    updateDatalistHotelRoomFromServer( 'AddRoomList', checkInVal, newCheckOut, guestCount);

            }
        }).data('lastValue', $('#txtCheckOut').val());
        $('#txtGuestCount').on('change', function () {
            clearRoomSelection();
            var checkIn = $('#txtCheckIn').val();
            var checkOut = $('#txtCheckOut').val();
            var guestCount = parseInt($(this).val()) || 1;

            var Days = tmpDays(checkIn, checkOut);
            Expense_Details(Days, 'txtExpenseDetails');

            updateDatalistHotelRoomFromServer('AddRoomList', checkIn, checkOut, guestCount);

        });

            var fechaActual = new Date().toISOString().split('T')[0];
            $('#txtCheckIn, #txtCheckOut').attr('min', fechaActual);
            $('#txtModifyCheckIn, #txtModifyCheckOut').attr('min', fechaActual);

        InitializerEventDropDownListClassic('ddlAddRoomModal', 'AddRoomList');

            InitializerEventDropDownList2('ddlModifyReservationModal', 'ModifyReservationList', 'ModifyTarifaList','');
        InitializerEventDropDownListClient('ddlModifyTarifaModal', 'ModifyTarifaList', 'Buscar tarifa...', 'txtModifyDescription', 'txtExpenseDetails','AddRoomList');

        $('#ddlAddReservationModal').select2({
            dropdownParent: $('#mdlAddReservation'),
            placeholder: 'Buscar cliente...',
            allowClear: true,
            minimumInputLength: 2,
            language: {
                inputTooShort: function (args) {
                    return 'Por favor ingrese ' + args.minimum + ' o más caracteres';
                },
                noResults: function () {
                    return "No se encontraron resultados";
                },
                searching: function () {
                    return "Buscando...";
                }
            },
            ajax: {
                url: '/Reservation/BuscarClientes',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term
                    };
                },
                processResults: function (data) {
                    console.log(data)
                    return {
                       
                        results: data.map(function (cliente) {
                            console.log(cliente.id)
                            return {
                                id: cliente.id,
                                text: cliente.nombre + ' - ' + cliente.cedula + ' (' + cliente.correo + ')'
                            };
                        })
                    };
                },
                cache: true
            }
        });

        $('#ddlAddReservationModal').on('change', function () {
    const clientId = $(this).val();
    const clientName = $('#ddlAddReservationModal option:selected').text();
    const checkIn = $('#txtCheckIn').val();
    const checkOut = $('#txtCheckOut').val();
    const guestCount = parseInt($("#txtGuestCount").val()) || 1;
    const roomId = $("#ddlAddRoomModal").val();


    const nights = tmpDays(checkIn, checkOut);

    const shouldClean =
        !clientId || !checkIn || !checkOut || nights <= 0;

    if (shouldClean) {
        $("#txtDescription").val("");
        $("#txtExpenseDetails").val("");
        return;
    }

  
    updateDatalistHotelRoomFromServer("AddRoomList", checkIn, checkOut, guestCount);
});

        $('#ddlAddReservationModal').on('select2:select', function (e) {
            const selectedClient = e.params.data;
            console.log("Cliente seleccionado:", selectedClient);
        });

        });

    function clearRoomSelection() {
        $('.room-card').removeClass('selected');
        $('#ddlAddRoomModal').val('');
        $('#ebNumberNight').text('');
        $('#ebPricePerNight').text('0.00');
        $('#ebSubTotal').text('0.00');
        $('#ebTax').text('0.00');
        $('#ebTotal').text('0.00');
    }


        function OpenModalAddReservation() {
            $("#btnModalAddReservation").click(function () {
                $("#mdlAddReservation").modal("show"); 
            });
        }
        function CloseModalAddReservation() {
            $("#btnCloseModalAddReservation").click(function () {
                $("#mdlAddReservation").modal("hide"); 
            });
        }
        function CloseModalModifyReservation() {
            $("#btnCloseModalModifyReservation").click(function () {
                $("#mdlModifyReservation").modal("hide"); 
            });
        }
    function CloseModalDeposit() {
        $("#btncloseDeposit").click(function () {
            $("#mdlDeposit").modal("hide"); 
        });
    }
        function OpenModalModifyReservation(button, modal) {

            var ReservationJson = button.getAttribute("data-reservation");
            var reservation = JSON.parse(ReservationJson);
            document.getElementById('ddlModifyReservationModal').value = reservation.Full_Name;
            document.getElementById('ddlModifyTarifaModal').value = reservation.ID_Rate;
            updateDatalistFromServer(reservation.IdCard_Client, 'ModifyTarifaList');
            ActivateInputEvent('ddlModifyTarifaModal');

            document.getElementById('txtModifyDescription').value = reservation.Reservation_Description;

            document.getElementById('txtModifyCheckIn').value = reservation.CheckIn.substring(0, 10)
            document.getElementById('txtModifyCheckOut').value = reservation.CheckOut.substring(0, 10)
            $('#hdfIdReservationModify').val(reservation.Id);

            OpenModal(modal);
        }


    function InitializerEventDropDownListClient(DropDownInput, dataList, Placeholder, txtDescription_ID, txtExpenseDetail,dataListHotelRoom) {
            var typingTimer;
            var doneTypingInterval = 1000;

            document.getElementById(DropDownInput).addEventListener("input", function () {
                clearTimeout(typingTimer);
                $("#ddlAddRoomModal").val('');
                typingTimer = setTimeout(function () {
                    var inputValue = document.getElementById(DropDownInput).value.toLowerCase();
                    var inputObject = document.getElementById(DropDownInput);
                    var options = document.getElementById(dataList).options;

                    for (var i = 0; i < options.length; i++) {
                        var option = options[i];
                        var text = option.textContent.toLowerCase();

                        if (text.indexOf(removeAccents(inputValue)) !== -1) {
                            option.style.display = "block";
                        } else {
                            option.style.display = "none";
                        }
                    }
                    var selectedOption = null;
                    for (var i = 0; i < options.length; i++) {
                        if (options[i].value === inputObject.value) {
                            selectedOption = options[i];
                            break;
                        }
                    }
                    if (selectedOption) {
                        inputObject.value = selectedOption.textContent;
                        var CheckIn = $("#txtCheckIn").val();
                        var CheckOut = $("#txtCheckOut").val();

                        var Days = tmpDays(CheckIn, CheckOut);

                        if (tmpDays(CheckIn, CheckOut) > 0) {
                             updateDatalistHotelRoomFromServer(selectedOption.value, dataListHotelRoom,CheckIn,CheckOut);
                        }



                    }
                    if (GetDropDownValueSelected(DropDownInput, dataList) === null) {
                        inputObject.value = '';
                        inputObject.placeholder = "No se encontró el registro digitado";
                        $("#txtDescription").val('');
                        $("#txtModifyDescription").val('');

                        $("#txtExpenseDetails").val('');
                        var pdataListHotelRoom = document.getElementById(dataListHotelRoom);
                        while (pdataListHotelRoom.options.length > 0) {
                            pdataListHotelRoom.removeChild(pdataListHotelRoom.options[0]);
                        }

                        typingTimer = setTimeout(function () {
                            inputObject.placeholder = Placeholder;
                        }, 1000)
                    }
                    else {

                        document.getElementById(DropDownInput).value = GetDropDownTextContentSelected(DropDownInput, dataList);
                        options[0].selected = true;
                    }
                }, doneTypingInterval);


            });
        }
        function InitializerEventDropDownList2(DropDownInput, dataList, dataListRate,dataListHotelRoom) {
            var typingTimer;
            var doneTypingInterval = 1000;

            document.getElementById(DropDownInput).addEventListener("input", function () {

                $("#ddlAddTarifaModal").val('');
                $("#ddlAddRoomModal").val('');
                $("#txtDescription").val('');
                $("#txtExpenseDetails").val('');

                clearTimeout(typingTimer);

                typingTimer = setTimeout(function () {
                    var inputValue = document.getElementById(DropDownInput).value.toLowerCase();
                    var inputObject = document.getElementById(DropDownInput);
                    var options = document.getElementById(dataList).options;

                    for (var i = 0; i < options.length; i++) {
                        var option = options[i];
                        var text = option.textContent.toLowerCase();

                        if (text.indexOf(removeAccents(inputValue)) !== -1) {
                            option.style.display = "block";
                        } else {
                            option.style.display = "none";
                        }
                    }
                    var selectedOption = null;
                    for (var i = 0; i < options.length; i++) {
                        if (options[i].value === inputObject.value) {
                            selectedOption = options[i];
                            break;
                        }
                    }
                    if (selectedOption) {

                        inputObject.value = selectedOption.textContent;

                        updateDatalistFromServer(selectedOption.value, dataListRate);
                    }
                    if (GetDropDownValueSelected(DropDownInput, dataList) === null) {
                        inputObject.value = '';
                        inputObject.placeholder = "No se encontró el registro digitado";
                        typingTimer = setTimeout(function () {
                            inputObject.placeholder = "Buscar cliente...";
                            var dataList = document.getElementById(dataListRate);
                            while (dataList.options.length > 0) {
                                dataList.removeChild(dataList.options[0]);
                            }

                            var pdataListHotelRoom = document.getElementById(dataListHotelRoom);
                            while (pdataListHotelRoom.options.length > 0) {
                                pdataListHotelRoom.removeChild(pdataListHotelRoom.options[0]);
                            }
                            $("#txtDescription").val('');
                            $("#txtModifyDescription").val('');

                            $("#txtExpenseDetails").val('');

                        }, 1000)
                    }
                    else {

                        document.getElementById(DropDownInput).value = GetDropDownTextContentSelected(DropDownInput, dataList);
                        options[0].selected = true;
                    }
                }, doneTypingInterval);


            });
        }
    function InitializerEventDropDownListClassic(DropDownInput, dataList) {
        var typingTimer;
        var doneTypingInterval = 1000;

        document.getElementById(DropDownInput).addEventListener("input", function () {
            clearTimeout(typingTimer);

            typingTimer = setTimeout(function () {
                var inputValue = document.getElementById(DropDownInput).value.toLowerCase();
                var inputObject = document.getElementById(DropDownInput);
                var options = document.getElementById(dataList).options;

                for (var i = 0; i < options.length; i++) {
                    var option = options[i];
                    var text = option.textContent.toLowerCase();

                    if (text.indexOf(removeAccents(inputValue)) !== -1) {
                        option.style.display = "block";
                    } else {
                        option.style.display = "none";
                    }
                }
                var selectedOption = null;
                for (var i = 0; i < options.length; i++) {
                    if (options[i].value === inputObject.value) {
                        selectedOption = options[i];
                        break;
                    }
                }
                if (selectedOption) {
                    inputObject.value = selectedOption.textContent;
                }
                if (GetDropDownValueSelected(DropDownInput, dataList) === null) {
                    inputObject.value = '';
                    inputObject.placeholder = "No se encontró el registro digitado";
                    typingTimer = setTimeout(function () {
                        inputObject.placeholder = "Seleccione una opción...";
                    }, 700)
                }
                else {

                    document.getElementById(DropDownInput).value = GetDropDownTextContentSelected(DropDownInput, dataList);
                    options[0].selected = true;
                }
            }, doneTypingInterval);


        });


    }

        function updateDatalistFromServer(Id_ClientSelected, dataListParameter) {

            $.ajax({
                type: "GET",
                url: "/Reservation/GetRateListByClientRateType?Id_ClientSelected=" + Id_ClientSelected.toString(),
                success: function (data) {

                    var dataList = document.getElementById(dataListParameter);
                    while (dataList.options.length > 0) {
                        dataList.removeChild(dataList.options[0]);
                    }

                    for (var i = 0; i < data.length; i++) {
                        var option = document.createElement("option");
                        option.value = data[i].Value;
                        option.text = data[i].Text;
                        dataList.appendChild(option);
                    }
                },
                error: function (error) {
                    console.error("Error al obtener los datos del servidor: " + error);
                }
            });
        }
    function updateDatalistHotelRoomFromServer(dataListContainerId, startDate, endDate, guestCount) {
        const prevRoomId = $('#ddlAddRoomModal').val();

        if (!(startDate instanceof Date)) startDate = new Date(startDate);
        if (!(endDate instanceof Date)) endDate = new Date(endDate);

        const formattedStartDate = startDate.toISOString().slice(0, 19).replace('T', ' ');
        const formattedEndDate = endDate.toISOString().slice(0, 19).replace('T', ' ');

        $.ajax({
            type: "GET",
            url: "/Reservation/GetHotelRoomListByCapacity",
            data: {
                StartDate: formattedStartDate,
                EndDate: formattedEndDate,
                GuestCount: guestCount
            },
            success: function (data) {
                const container = $('#roomCardsContainer');
                container.empty();

                if (data.length === 0) {
                    Swal.fire('', 'No hay habitaciones disponibles en las fechas solicitadas.', 'error');
                    clearRoomSelection();
                    return;
                }

                let foundPrev = false;
                data.forEach(hotel => {
                    const card = $(`
                  <div class="room-card" data-room-id="${hotel.ID}">
                    <strong>${hotel.Description}</strong><br/>
                    <span>Precio: ₡${parseFloat(hotel.Price).toLocaleString('es-CR', { minimumFractionDigits: 2 })}</span><br/>
                    <span>USD: $${parseFloat(hotel.DolarPrice).toFixed(2)}</span><br/>
                    <small>ID: ${hotel.ID}</small>
                  </div>
                `);

                    // Seleccionar solo si existe
                    if (hotel.ID.toString() === prevRoomId) {
                        card.addClass('selected');
                        foundPrev = true; // Ya NO pones el val aquí
                    }

                    card.on('click', function () {
                        $('.room-card').removeClass('selected');
                        $(this).addClass('selected');
                        $('#ddlAddRoomModal').val(hotel.ID);
                        const days = tmpDays($('#txtCheckIn').val(), $('#txtCheckOut').val());
                        Expense_Details(days, 'txtExpenseDetails');
                    });

                    container.append(card);
                });

                // Ahora aquí, solo si la habitación sigue existiendo, la pones
                if (foundPrev) {
                    $('#ddlAddRoomModal').val(prevRoomId);

                    const days = tmpDays($('#txtCheckIn').val(), $('#txtCheckOut').val());
                    Expense_Details(days, 'txtExpenseDetails');
                } else {
                    $("#ddlAddRoomModal").val('');
                    clearRoomSelection();
                }
            },
            error: function (error) {
                console.error("Error al obtener habitaciones:", error);
            }
        });
    }
    function Expense_Details(numberOfNights, txtExpenseDetail) {
        const roomId = $("#ddlAddRoomModal").val();
        if (!roomId) {
            console.log("No hay habitación seleccionada.");
            return;
        }

        $.ajax({
            type: "GET",
            url: "/Reservation/Expense_Details",
            data: {
                numberOfNights: numberOfNights,
                roomId: roomId
            },
            success: function (data) {
                if (data === null) {
                    $("#expenseBreakdown").html("<p>No se pudo obtener el desglose.</p>");
                    return;
                }

                $("#ebPricePerNight").text(data.PricePerNight.toLocaleString('es-CR', { minimumFractionDigits: 2 }));
                $("#ebSubTotal").text(data.SubTotal.toLocaleString('es-CR', { minimumFractionDigits: 2 }));
                $("#ebTax").text(data.Tax.toLocaleString('es-CR', { minimumFractionDigits: 2 }));
                $("#ebTotal").text(data.Total.toLocaleString('es-CR', { minimumFractionDigits: 2 }));
                $("#ebNumberNight").text(data.Nights);

            },
            error: function (error) {
                console.error("Error al obtener los datos del servidor:", error);
            }
        });
    }


    function FilterReservacion() {
        var selectedValue = $('#ddlReservationStatus').val();
     var checkInVal = $('#txtCheckInReservation').val();
     var checkOutVal = $('#txtCheckOutReservation').val();

     if (!(checkInVal instanceof Date)) checkInVal = new Date(checkInVal);
     if (!(checkOutVal instanceof Date)) checkOutVal = new Date(checkOutVal);


     var formattedStartDate = checkInVal.toISOString().slice(0, 19).replace('T', ' ');
     var formattedEndDate = checkOutVal.toISOString().slice(0, 19).replace('T', ' ');

        console.log(formattedStartDate + " " + formattedEndDate)

     mostrarSpinner();
            $.ajax({
               url: '@Url.Action("SeachReservationByStatus", "Reservation")',
               type: 'GET',
                data: {
                    reservationStatus: selectedValue,
                    StartDate: formattedStartDate,
                    EndDate: formattedEndDate
                },
                success: function (partialView) {
                    if ($.fn.DataTable.isDataTable('#tblReservation')) {
                        $('#tblReservation').DataTable().destroy();
                    }
                   $('#contenedorVistaParcial').html(partialView);

                   $('#tblReservation').DataTable({

                       "paging": true,
                       "lengthChange": true,
                       "searching": true,
                       "ordering": true,
                       "responsive": true,
                       "buttons": [
                           'copy', 'excel', 'pdf', 'print'
                       ],
                       "lengthMenu": [[5, 10, 25, 50, 100], [5, 10, 25, 50, "Todo"]],
                       "language": {
                           "lengthMenu": "Mostrar _MENU_ registros por página",
                           "zeroRecords": "No se encontraron registros",
                           "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                           "infoEmpty": "No hay registros disponibles",
                           "infoFiltered": "(filtrados de _MAX_ registros en total)",
                           "search": "Buscar:",
                           "paginate": {
                   "first": "Primero",
                   "last": "Último",
                   "next": "Siguiente",
                   "previous": "Anterior"
               }
           }
       });
   },
       error: function() {
       alert('Ha ocurrido un error al obtener los datos.');
                   }
       });
     ocultarSpinner();

    }


    //$('.contentPDF').resizable({
    //    //alsoResize: ".modal-dialog",
    //    //minHeight: 150
    //});
    //$('.dialogPDF').draggable();

    //$('#modalPDF').on('show.bs.modal', function () {
    //    $(this).find('.modalbodypdf').css({

    //        'max-height': '100%'
    //    });
    //    $(this).find('.divPDF').css({
    //        'max-height': '100%'
    //    });
    //});

    //var EstadoModalMaximizado = false;
    //const WidthInicial = 798;
    //const HeigthInicial = 628;

    //function MaximizarModalPDf() {

    //    var heightWindows = $(window).height();
    //    var widthWindows = $(window).width();

    //    var width = $('.contentPDF').width();
    //    var height = $('.contentPDF').height();

    //    if (!EstadoModalMaximizado) {

    //        $('.contentPDF').css("height", heightWindows);
    //        $('.contentPDF').css("width", widthWindows - 10);
    //        EstadoModalMaximizado = true;

    //    }
    //    else {

    //        $('.contentPDF').width(WidthInicial);
    //        $('.contentPDF').height(HeigthInicial);
    //        EstadoModalMaximizado = false;
    //    }
    //}

    //$('.modal-header').dblclick(() => {

    //    var heightWindows = $(window).height();
    //    var widthWindows = $(window).width();

    //    var width = $('.contentPDF').width();
    //    var height = $('.contentPDF').height();


    //    if (!EstadoModalMaximizado) {

    //        $('.contentPDF').css("height", heightWindows);
    //        $('.contentPDF').css("width", widthWindows - 10);
    //        $('.contentPDF').css("left", 0);
    //        EstadoModalMaximizado = true;

    //    }
    //    else {

    //        $('.contentPDF').width(WidthInicial);
    //        $('.contentPDF').height(HeigthInicial);
    //        EstadoModalMaximizado = false;
    //    }
    //});

</script>

<script src="~/Content/JS/Reservation/jsReservation.js"></script>
